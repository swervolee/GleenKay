<!DOCTYPE html>
{% load widget_tweaks %}

{% load static %}
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Parent's Dashboard</title>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
		<script src="https://kit.fontawesome.com/11f4cefc5f.js" crossorigin="anonymous"></script>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,400,700&display=swap">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
		<link rel="stylesheet" href="https://cdn.rawgit.com/michalsnik/aos/2.1.1/dist/aos.css">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-beta2/css/bootstrap.min.css">
		<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js"></script>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="{% static 'styles/parent_home.css'%}">
		<script src="{% static 'scripts/parent_home.js' %}"></script>
	</head>
	<body>
		{% if request.user.user_type == "parent" %}
		<div class="container-fluid">
			<div class="row">
				<!-- Sidebar (visible by default with 'show' class) -->

				<nav id="sidebar" class="col-md-3 col-lg-2 bg-light text-dark vh-100 collapse show d-lg-flex flex-column justify-content-between shadow-lg">
					<!-- Navigation Links -->
					<ul class="nav flex-column mt-4 rounded">
						<li class="nav-item mb-2 rounded">
							<a class="nav-link active text-primary fw-bold py-3 px-4 d-flex align-items-center" href="#" style="transition: background-color 0.3s;">
								<i class="bi bi-house-door me-3"></i> Dashboard
							</a>
						</li>
						<li class="nav-item mb-2 rounded">
							<a class="nav-link text-dark py-3 px-4 d-flex align-items-center" href="#" style="transition: background-color 0.3s;">
								<i class="bi bi-person-lines-fill me-3"></i> Manage Child Accounts
							</a>
						</li>
						<li class="nav-item mb-2 rounded">
							<a class="nav-link text-dark py-3 px-4 d-flex align-items-center" href="#" style="transition: background-color 0.3s;">
								<i class="bi bi-wallet2 me-3"></i> Payment History
							</a>
						</li>
					</ul>

					<!-- Logout Button -->
					<div class="d-flex justify-content-center mt-auto mb-4">
						<a href="{% url 'Authentication:logout_user' %}" class="btn btn-outline-danger d-flex align-items-center px-4 py-2" style="transition: background-color 0.3s;">
							<i class="bi bi-box-arrow-right me-2"></i> Logout
						</a>
					</div>
				</nav>






				<!-- Header (taking up the remaining space beside the sidebar) -->
				<header class="col-md-9 col-lg-10 animate__animated animate__fadeInDown sticky-header rounded">
					<nav class="navbar navbar-expand-lg navbar-dark bg-gradient shadow-lg py-3 rounded">
						<a class="navbar-brand text-center font-weight-bold d-none d-lg-block text-light" href="#" style="font-size: 2rem; letter-spacing: 2px;">
							<i class="bi bi-book-fill me-2"></i> GLEENKAY ACADEMY
						</a>
					</nav>
				</header>




				<!-- nav for small devices -->
				<nav class="navbar navbar-expand-lg navbar-dark d-lg-none d-sm-none rounded p-1" style="position: fixed; top: 0; left: 0; right: 0; z-index: 1000;">
					<div class="container-fluid">
						<a class="navbar-brand text-left" href="#">GLEENKAY</a>
						<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mobileNavbar" aria-controls="mobileNavbar" aria-expanded="false" aria-label="Toggle navigation">
							<span class="navbar-toggler-icon"></span>
						</button>
						<div class="collapse navbar-collapse" id="mobileNavbar">
							<!-- X button for closing the menu -->
							<button class="btn btn-close text-white float-end mb-2" id="closeMenu" aria-label="Close" style="font-size: 1.2rem; background: black">&times;</button>

							<!-- Navigation links (same as desktop) -->
							<div class="w-75 mx-auto">
								<ul class="navbar-nav">
									<li class="nav-item">
										<a class="nav-link" href="#">
											<i class="bi bi-house-door"></i> Dashboard
										</a>
									</li>
									<li class="nav-item">
										<a class="nav-link" href="#">
											<i class="bi bi-person-lines-fill"></i> Manage Child Accounts
										</a>
									</li>
									<li class="nav-item">
										<a class="nav-link" href="#">
											<i class="bi bi-wallet2"></i> Payment History
										</a>
									</li>
								</ul>
							</div>

							<!-- Logout Button for mobile screens -->
							<div class="w-75 mx-auto mt-1">
								<a href="{% url 'Authentication:logout_user' %}" class="btn d-flex text-light align-items-center px-4 py-2 w-100" style="transition: background-color 0.3s;">
									<i class="bi bi-box-arrow-right me-2 text-light"></i> Logout
								</a>
							</div>
						</div>
					</div>
				</nav>	





				<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
					<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
						<h1 class="h2">Welcome, {{parent}}</h1>
					</div>


					<section>
						<div class="card-container dashboard">
							<div class="card">
								<div class="card-body">
									<h3 class="card-title">Your Child Accounts</h3>


									<ul class="list-group mb-3">
										{% for child in children %}
										<li class="list-group-item d-flex justify-content-between align-items-center shadow-sm py-3">
											<!-- Child Information -->
											<div class="d-flex align-items-center">
												<div class="avatar avatar-sm me-3">
													<img src="{% static 'images/1-student.png'%}" alt="{{ child.first_name }}" class="rounded-circle" width="40" height="40">
												</div>
												<div>
													<h6 class="mb-0">{{ child.first_name }} {{ child.last_name }}</h6>
													<small class="text-muted">Grade {{ child.grade_level }}</small>
												</div>
											</div>

											<!-- Dropdown button for actions -->
											<div class="dropdown">
												<button class="btn btn-outline-primary dropdown-toggle btn-sm px-3" type="button" id="dropdownMenuButton{{ child.id }}" data-bs-toggle="dropdown" aria-expanded="false">
													<i class="bi bi-gear"></i> Actions
												</button>
												<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton{{ child.id }}">
													<li><a class="dropdown-item" href="child/{{child.id}}"><i class="bi bi-person"></i> Open Account</a></li>
													<li><a class="dropdown-item" href="#" onclick="openBookingModal('{{child.first_name}} {{child.last_name}}', {{ child.id }})"><i class="bi bi-calendar-check"></i> Book Lesson</a></li>
													<li><a class="dropdown-item text-danger" href="#" onclick="confirmDelete('{{child.id}}', '{{child.first_name}} {{child.last_name}}')"><i class="bi bi-trash"></i> Delete Account</a></li>
												</ul>
											</div>
										</li>
										{% empty %}
										<li class="list-group-item text-center">No Child Accounts Found.</li>
										{% endfor %}
									</ul>

									<!-- Delete Confirmation Modal -->
									<div class="modal fade" id="deleteChildModal" tabindex="-1" aria-labelledby="deleteChildModalLabel" aria-hidden="true">
										<div class="modal-dialog modal-dialog-centered">
											<div class="modal-content shadow-lg border-0 rounded">
												<div class="modal-header bg-danger text-white">
													<h5 class="modal-title" id="deleteChildModalLabel">
														<i class="bi bi-trash3-fill"></i> Confirm Deletion
													</h5>
													<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
												</div>
												<div class="modal-body">
													<p class="text-center mb-4">Are you sure you want to delete the account for <strong id="childNameToDelete"></strong>? This action is permanent and cannot be undone.</p>
													<!-- Form for password confirmation -->
													<form id="deleteChildForm" method="post" action="delete/{{ child.id }}">
														{% csrf_token %}
														<div class="mb-3">
															<label for="confirmPassword" class="form-label fw-bold">Enter your password to confirm:</label>
															<input type="password" class="form-control rounded border-dark" id="confirmPassword" name="confirmPassword" placeholder="Enter your password" required>
														</div>
														<div class="d-flex justify-content-center mt-4">
															<button type="button" class="btn btn-secondary mx-2" data-bs-dismiss="modal">
																<i class="bi bi-x-circle"></i> Cancel
															</button>
															<button type="submit" class="btn btn-danger mx-2" onclick="submitDelete()">
																<i class="bi bi-trash-fill"></i> Confirm Delete
															</button>
															
														</div>
													</form>
												</div>
											</div>
										</div>
									</div>

									<script>
										function confirmDelete(childId, childName) {
											// Set the child name in the modal
											$('#childNameToDelete').text(childName);

											// Update the form action to include the child ID
											const deleteForm = $('#deleteChildForm');
											deleteForm.attr('action', `/delete/${childId}`);

											// Show the modal
											const deleteModal = new bootstrap.Modal(document.getElementById('deleteChildModal'));
											deleteModal.show();
										}

										function submitDelete(event) {
											event.preventDefault(); // Prevent default form submission

											const password = $('#confirmPassword').val();
											const deleteForm = $('#deleteChildForm');
											const formData = new FormData(deleteForm[0]); // Get the form data

											if (password) {
												// Send an AJAX request using fetch
												fetch(deleteForm.attr('action'), {
													method: 'POST',
													body: formData,
													headers: {
														'X-CSRFToken': '{{ csrf_token }}', // Include CSRF token for security
													},
												})
													.then(response => {
														if (response.ok) {
															return response.json(); // Parse JSON response if needed
														} else {
															throw new Error('Error occurred while deleting the child account.');
														}
													})
													.then(data => {
														// Handle successful deletion (e.g., show success message, redirect)
														alert('Child account deleted successfully!');
														location.reload(); // Optionally reload or redirect
													})
													.catch(error => {
														// Handle errors (e.g., show error message)
														alert(error.message);
													});
											} else {
												alert('Please enter your password.');
											}
										}
									</script>



									<!-- Custom Booking Modal -->
									<!-- Modal -->
									<!-- Custom Booking Modal -->
									<div id="bookingModal" class="modal fade" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
										<div class="modal-dialog modal-dialog-centered">
											<div class="modal-content shadow-lg border-0 rounded-3 animate__animated animate__zoomIn">
												<div class="modal-header bg-gradient bg-primary text-white rounded-top">
													<h5 class="modal-title fw-bold" id="bookingModalLabel">
														<i class="bi bi-calendar-check-fill me-2"></i> Book Math Lesson for <span id="childNameDisplay"></span>
													</h5>
													<button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="closeBookingModal()"></button>
												</div>
												<div class="modal-body p-4 bg-light">
													<form id="bookLessonForm" onsubmit="bookLesson(event)" method="POST">
														{% csrf_token %}
														<input type="hidden" id="childName" name="user_id"> <!-- Add the name attribute to send with the form -->

														<div class="mb-4">
															<label for="date" class="form-label fw-bold">Select Date</label>
															{% render_field booking_form.date type="date" class="form-control shadow-sm border-primary rounded-3" placeholder="YYYY-MM-DD" %}
														</div>

														<div class="mb-4">
															<label for="time" class="form-label fw-bold">Select Time</label>
															{% render_field booking_form.time type="time" class="form-control shadow-sm border-primary rounded-3" placeholder="HH:MM" %}
														</div>

														<div class="mb-4">
															<label for="mathArea" class="form-label fw-bold">Math Area</label>
															<select id="mathArea" class="form-select shadow-sm border-primary rounded-3" required onchange="flashy()" name="{{ booking_form.topic.name }}">
																<option value="" selected disabled hidden>Choose Math Topic</option>
																{% for value, label in booking_form.topic.field.choices %}
																{% if value %}
																<option value="{{ value }}">{{ label }}</option>
																{% endif %}
																{% endfor %}
															</select>
														</div>

														<div class="mb-4" id="otherMathAreaContainer" style="display: none;">
															<label for="otherMathArea" class="form-label fw-bold">Please specify:</label>
															{% render_field booking_form.other_topic id="otherMathArea" class="form-control shadow-sm border-primary rounded-3" %}
														</div>

														<button type="submit" class="btn btn-primary w-100 py-2 shadow-lg rounded-3 fw-bold">
															<i class="bi bi-check-circle-fill me-2"></i> Confirm Booking
														</button>
													</form>
												</div>
											</div>
										</div>
									</div>



									<!-- Confirmation Message -->
									<!-- Flash Message Placeholder -->
									<div id="flashMessage" class="alert alert-dark d-none position-fixed top-0 end-0 m-3" role="alert" style="z-index: 1050;">
										Lesson booked successfully! An email will be sent shortly with the schedule.
									</div>

									<button class="btn btn-primary mb-3" data-bs-toggle="collapse" data-bs-target="#childAccountFormCollapse">Add New Child</button>
									<div class="collapse" id="childAccountFormCollapse">
										<div class="card border-0 shadow-lg" id='childform' style="background-color: #f8f9fa;">
											<div class="card-body">
												<h5 class="card-title text-center text-uppercase fw-bold text-primary mb-4">Create Child Account</h5>
												<!-- Changed form ID here -->
												<form id="createChildForm" method="post" onsubmit="createChildAccount(event)">
													{% csrf_token %}
													<div class="row">
														<div class="col-lg-3 mb-4">
															<label for="firstName" class="form-label fw-bold text-dark">First Name</label>
															{% render_field form.first_name class="form-control form-control-lg rounded-pill shadow-sm" placeholder="First Name" %}
														</div>
														<div class="col-lg-3 mb-4">
															<label for="lastName" class="form-label fw-bold text-dark">Last Name</label>
															{% render_field form.last_name class="form-control form-control-lg rounded-pill shadow-sm" placeholder="Last Name" %}
														</div>
														<div class="col-lg-2 mb-4">
															<label for="age" class="form-label fw-bold text-dark">Age</label>
															{% render_field form.age class="form-control form-control-lg rounded-pill shadow-sm" placeholder="Age" %}
														</div>
														<div class="col-lg-2 mb-4">
															<label for="gender" class="form-label fw-bold text-dark">Gender</label>
															<select name="{{ form.gender.name }}" id="{{ form.gender.auto_id }}" class="form-control form-control-lg rounded-pill shadow-sm">
																<option value="" selected disabled hidden>Select Gender</option>
																{% for value, label in form.gender.field.choices %}
																{% if value %}
																<option value="{{ value }}">{{ label }}</option>
																{% endif %}
																{% endfor %}
															</select>
														</div>

														<div class="col-lg-2 mb-4">
															<label for="gradeLevel" class="form-label fw-bold text-dark">Grade Level</label>
															<select name="{{ form.grade_level.name }}" id="{{ form.grade_level.auto_id }}" class="form-control form-control-lg rounded-pill shadow-sm">
																<option value="" selected disabled hidden>Select Grade</option>
																{% for value, label in form.grade_level.field.choices %}
																{% if value %}
																<option value="{{ value }}">{{ label }}</option>
																{% endif %}
																{% endfor %}
															</select>
														</div>
													</div>

													<div class="mb-4">
														<label for="learningAreas" class="form-label fw-bold text-dark">Learning Areas</label>
														<select name="{{ form.learning_areas.name }}" id="{{ form.learning_areas.auto_id }}" class="form-control form-control-lg rounded-pill shadow-sm">
															<option value="" selected disabled hidden>Select Learning Areas</option>
															{% for value, label in form.learning_areas.field.choices %}
															{% if value %}
															<option value="{{ value }}">{{ label }}</option>
															{% endif %}
															{% endfor %}
														</select>
													</div>

													<div class="mb-4">
														<label for="profileAvatar" class="form-label fw-bold text-dark">Profile Avatar</label>
														{% render_field form.profile_avatar class="form-control form-control-lg rounded-pill shadow-sm" %}
													</div>

													<div class="mb-4">
														<label for="notes" class="form-label fw-bold text-dark">Notes</label>
														<textarea class="form-control form-control-lg rounded shadow-sm" id="notes" rows="3" placeholder='Tell us something we should know about your child'></textarea>
													</div>

													<div class="text-center">
														<button type="submit" class="btn btn-primary px-5 py-2 rounded-pill shadow-sm fw-bold">Create Account</button>
													</div>
												</form>
											</div>
										</div>
									
									</div>

								</div>
							</div>
						</div>
					</section>



					<!-- Student info-->
					<div class="container singular mt-5">
						<div class="row justify-content-center">
							<!-- Student Card -->
							{% for child in children %}
							<div class="col-md-4 col-sm-12 mb-4">
								<div class="card student-card rounded shadow-lg border-0 h-100" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
									<div class="photo text-center mt-4">
										<img src="{% static 'images/1-student.png' %}" alt="Student Photo" class="rounded-circle img-fluid" style="width: 150px; height: 150px; object-fit: cover; border: 5px solid #ffffff;">
									</div>
									<div class="card-body text-center">
										<h5 class="card-title fw-bold text-primary">{{ child.first_name}} {{child.last_name}}</h5>
										<p class="card-text text-muted mb-1"><strong>Grade:</strong> {{child.grade_level}}</p>
										<p class="card-text text-muted mb-1"><strong>Age:</strong> {{child.age}}</p>
										<p class="card-text text-muted mb-1"><strong>Contact:</strong> 123-456-7890</p>
										<p class="card-text text-muted mb-3"><strong>Next Lesson:</strong> Math (Due: Oct 10, 2024)</p>

										<!-- Open Account Button -->
										<a href='child/{{child.id}}' class="btn btn-primary mt-3 px-4 py-2 rounded-pill shadow-sm" style="transition: background-color 0.3s ease;">
											Open Account
										</a>
									</div>
								</div>
							</div>
							{% endfor %}
						</div>
					</div>
				
					<!-- Payment History Section -->
					<section class="container-fluid payments">
						<div class="row justify-content-center">
							<div class="col-12">
								<div class="card-container shadow-lg">
									<div class="card">
										<div class="card-header bg-danger text-light text-center">
											<h4 class="mb-0">Payment History</h4>
										</div>
										<div class="card-body">
											<ul class="list-group mb-3">
												<li class="list-group-item d-flex justify-content-between align-items-center">
													<span><i class="bi bi-calendar-check me-2 text-success"></i> Payment on 01 Jan 2024</span>
													<span class="badge bg-success">$50</span>
												</li>
												<li class="list-group-item d-flex justify-content-between align-items-center">
													<span><i class="bi bi-calendar-check me-2 text-warning"></i> Payment on 15 Feb 2024</span>
													<span class="badge bg-warning">$75</span>
												</li>
												<li class="list-group-item d-flex justify-content-between align-items-center">
													<span><i class="bi bi-calendar-check me-2 text-danger"></i> Payment on 10 Mar 2024</span>
													<span class="badge bg-danger">$100</span>
												</li>
												<li class="list-group-item d-flex justify-content-between align-items-center">
													<span><i class="bi bi-calendar-check me-2 text-info"></i> Payment on 20 Mar 2024</span>
													<span class="badge bg-info">$125</span>
												</li>
												<li class="list-group-item d-flex justify-content-between align-items-center">
													<span><i class="bi bi-calendar-check me-2 text-success"></i> Payment on 05 Apr 2024</span>
													<span class="badge bg-success">$150</span>
												</li>
											</ul>
											<button class="btn btn-outline-dark w-100" id="loadMorePayments">
												<i class="bi bi-plus-circle me-2"></i> View More Payments
											</button>
										</div>
									</div>
								</div>
							</div>
						</div>
					</section>





				</main>
			</div>
		</div>

		{% if messages %}
		{% for message in messages %}
		{% if "success" in message.tags %}
		<span class="alert alert-success text-center" style="color: green; position:inherit; display:block;" >{{ message }}</span>
		{% else %}
		<span class="alert alert-danger text-center" style="color: #721c24; position:inherit; display:block;"><strong>{{ message }}</strong> please try again</span>
		{% endif %}
		{% endfor %}
		{% endif %}


		<script>
			function openBookingModal(childName, childId) {
				document.getElementById('childNameDisplay').innerText = childName;
				document.getElementById('childName').value = childId; // Set the hidden input field
				const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
				bookingModal.show();
			}

			function closeBookingModal() {
				const bookingModal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
				bookingModal.hide();
			}

			// Modify the bookLesson function to handle form submission
			function bookLesson(event) {
				event.preventDefault(); // Prevent the default form submission
				const form = document.getElementById('bookLessonForm');
				const formData = new FormData(form);

				// Send the form data via fetch
				fetch(form.action, {
					method: 'POST',
					body: formData,
					headers: {
						'X-CSRFToken': '{{ csrf_token }}', // Make sure to include the CSRF token
					},
				})
					.then(response => {
						if (response.ok) {
							// Handle success (e.g., show a success message, refresh the page)
							closeBookingModal(); // Close the modal after successful booking
							location.reload(); // Reload to see changes, or handle it differently
						} else {
							// Handle error (e.g., show an error message)
							alert('Error booking lesson. Please try again.');
						}
					});
			}
		</script>

		{% else %}
		Oops, Unauthorized Access
		{% endif %}
	</body>
</html>
